receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # Host metrics receiver - collects actual CPU/memory from container
  hostmetrics:
    collection_interval: 30s
    root_path: /hostfs
    scrapers:
      cpu:
        metrics:
          system.cpu.utilization:
            enabled: true
      memory:
        metrics:
          system.memory.utilization:
            enabled: true
      load:
      network:
      paging:

  # Redis metrics receiver
  redis:
    endpoint: redis:6379
    collection_interval: 30s
    # No password - Redis is running without auth
    metrics:
      redis.maxmemory:
        enabled: true
      redis.cmd.latency:
        enabled: true

processors:
  batch:
    timeout: 1s
    send_batch_size: 1024

  resourcedetection:
    detectors: [env, system, docker]
    timeout: 5s
    override: false

  # Ensure host.name from resource is copied to metric attributes
  # Set both dot and underscore formats for compatibility with SigNoz dotMetrics setting
  transform/metrics:
    metric_statements:
      - context: datapoint
        statements:
          - set(attributes["host.name"], resource.attributes["host.name"]) where resource.attributes["host.name"] != nil
          - set(attributes["host_name"], resource.attributes["host.name"]) where resource.attributes["host.name"] != nil
          - set(attributes["os.type"], resource.attributes["os.type"]) where resource.attributes["os.type"] != nil
          - set(attributes["os_type"], resource.attributes["os.type"]) where resource.attributes["os.type"] != nil

connectors:
  # Forward connector to fan-out hostmetrics to multiple pipelines
  forward/hostmetrics:

exporters:
  otlp:
    endpoint: ${env:OTLP_ENDPOINT}
    headers:
      signoz-ingestion-key: ${env:SIGNOZ_INGESTION_KEY}
    tls:
      insecure: ${env:OTLP_INSECURE}
      insecure_skip_verify: ${env:OTLP_INSECURE_SKIP_VERIFY}

service:
  telemetry:
    logs:
      level: info

  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [otlp]

    # Service-emitted metrics
    metrics:
      receivers: [otlp]
      processors: [resourcedetection, transform/metrics, batch]
      exporters: [otlp]

    # Collector's hostmetrics (for otel-collector host)
    metrics/hostmetrics:
      receivers: [hostmetrics]
      processors: [resourcedetection, batch]
      exporters: [otlp]

    # Redis metrics
    metrics/redis:
      receivers: [redis]
      processors: [resourcedetection, batch]
      exporters: [otlp]

    logs:
      receivers: [otlp]
      processors: [batch]
      exporters: [otlp]
